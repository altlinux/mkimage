#!/bin/ash -efu

. shell-error

no_cache="${NO_CACHE:-}"
dir="${WORKDIR:?work directory required}"
outdir="${OUTDIR:?out directory required}"
cachedir="${CACHEDIR:?cache directory required}"
makefile="${MYMAKEFILE:?makefile required}"

payload() {
	stat --printf='%A\t%s\t%Y\n' "$makefile"

	cd "$aptbox/var"
	find -name '*_release' -exec cat '{}' '+'
	cd - >/dev/null

	cd "$outdir"
	find -mindepth 1 -printf '%M\t%s\t%T@\t%p\n'
	cd - >/dev/null
}

sha=
invalid_cache() {
	printf '%s\n' "$sha" > "$cachefile"
	exit 1
}

aptbox="$dir/aptbox"
[ -d "$aptbox" ] ||
	exit 1

"$aptbox"/apt-get update

sha="`payload |sha256sum - |cut -d\  -f1`"

cachefile="$cachedir/mkicache"
[ -s "$cachefile" ] ||
	invalid_cache

old_sha="`head -1 "$cachefile"`"
[ "$old_sha" = "$sha" ] ||
	invalid_cache

[ -z "$no_cache" ] ||
	invalid_cache
