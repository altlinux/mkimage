#!/bin/ash -efu

. "${0%/*}"/mki-sh-functions

verbose "has started executing."

destdir="${MKI_DESTDIR:-}"
REQUIRES="${IMAGE_PACKAGES:-}"
aptboxdir="${PKGBOX:?global aptbox required}"

tempdir=
exit_handler() {
    local rc=$?
    trap - EXIT
    [ -z "$tempdir" ] || rm -rf -- "$tempdir"
    exit $rc
}

if [ -z "$REQUIRES" ]; then
	message "Nothing to do."
	exit  0
fi


trap exit_handler HUP INT QUIT TERM EXIT
tempdir="$(mktemp -d "$dir/$PROG.XXXXXXXXX")"

lstfile="$tempdir/lst"
errfile="$tempdir/err"
reqfile="$tempdir/req"

for r in $REQUIRES; do
	if [ -f "$r" ]; then
		grep -h '^[[:space:]]*[^#]' "$r" ||:
	else
		printf '%s\n' "$r"
	fi
done > "$reqfile"

if [ ! -s "$reqfile" ]; then
	message "Nothing to do."
	exit 0
fi

> "$lstfile"
> "$errfile"

rc=0
xargs -r mki-print-uris 2>>"$errfile" >>"$lstfile" < "$reqfile" ||
	rc=$?

conflicts=
if [ "$rc" -ne 0 ]; then
	if ! conflicts="$(LANG=C fgrep ': Conflicts: ' "$errfile")"; then
		cat "$errfile" >&2
		fatal 'could not copy packages: conflicts found.'
	fi
	> "$lstfile"
fi

if [ ! -s "$lstfile" ]; then
	verbose "Conflicts packages found in requires list: "
	[ -z "$verbose" ] ||
		printf '%s\n' "$conflicts" >&2

	while read -r line; do
		[ -n "$line" ] ||
			continue

		mki-print-uris $line

	done < "$reqfile" > "$lstfile"
fi

[ -s "$lstfile" ] ||
	fatal 'could not copy packages: empty list.'

sort -u "$lstfile" |
	tr ' ' '\n' |
	xargs -r cp $verbose -ut "$chroot/.in/" -- ||
	fatal 'could not copy packages: copy failed.'

cat > "$chroot/tmp/script" <<EOF
#!/bin/sh -efu
mkdir $verbose -p -- '/.image/$destdir'
exec /.host/find /.in -mindepth 1 -maxdepth 1 -execdir cp $verbose -alft '/.image/$destdir' -- '{}' '+'
EOF

rc=0
mki-exec "$chroot/tmp/script" || rc=$?
rm -f -- "$chroot/tmp/script"
find "$chroot/.in/" -mindepth 1 -maxdepth 1 -execdir rm $verbose -rf -- '{}' '+'
exit $rc
