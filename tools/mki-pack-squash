#!/bin/ash -efu

. "${0%/*}"/mki-sh-functions

nproc="${PACK_SQUASHFS_PROCESSORS:-}"
nproc="$(opt_check_number 'PACK_SQUASHFS_PROCESSORS' "$nproc")"

outname="${MKI_OUTNAME:-outname}"
outname="${outname##*/}"

[ -d "$chroot" ] ||
	fatal "$dir: not look like a work directory of hasher."

mki-install squashfsprogs

update_chroot_fakedata

cat >"$chroot/tmp/packimage.sh"<<EOF
#!/bin/sh -efu

args=
[ ! -d /.image/.in ]       || args="\$args /.image/.in"
[ ! -d /.image/.host ]     || args="\$args /.image/.host"
[ ! -f /.image/.fakedata ] || args="\$args /.image/.fakedata"

[ ! -e '/.our/$outname' ] ||
	rm -f -- '/.our/$outname'

exec mksquashfs /.image/ '/.our/$outname' ${nproc:+-processors $nproc} ${args:+-e $args}
EOF

mki-exec "$chroot/tmp/packimage.sh"
rm -f -- "$chroot/tmp/packimage.sh"
mki-copy-our2out
